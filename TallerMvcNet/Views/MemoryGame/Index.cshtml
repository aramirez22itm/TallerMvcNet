@model List<TallerMvcNet.Models.ScoreRecord>

<style>
    .game-board {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        max-width: 400px;
        margin: 0 auto;
    }

    .card-game {
        height: 80px;
        background-color: #2c3e50;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 2rem;
        color: transparent; /* Ocultamos el emoji */
        transition: transform 0.3s;
    }

        .card-game.flipped {
            background-color: #ecf0f1;
            color: #2c3e50; /* Mostramos el emoji */
            transform: rotateY(180deg);
        }

        .card-game.matched {
            background-color: #27ae60;
            color: white;
            cursor: default;
        }
</style>

<div class="container mt-4 text-center">
    <h2>🧩 Juego de Memoria</h2>

    <div class="row mb-3">
        <div class="col">Movimientos: <strong id="moveCount">0</strong></div>
        <div class="col">Tiempo: <strong id="timer">0</strong>s</div>
    </div>

    <div id="board" class="game-board mb-4">
    </div>

    <button class="btn btn-warning" onclick="restartGame()">🔄 Reiniciar Juego</button>

    <hr />

    <div id="winForm" class="card mx-auto shadow border-success" style="max-width: 400px; display: none;">
        <div class="card-header bg-success text-white">🎉 ¡Ganaste!</div>
        <div class="card-body">
            <p>Puntaje Final: <strong id="finalScoreDisplay">0</strong></p>
            <form asp-action="SaveScore" method="post">
                <input type="hidden" name="moves" id="inputMoves" />
                <input type="hidden" name="timeSeconds" id="inputTime" />
                <input type="hidden" name="score" id="inputScore" />

                <input name="playerName" class="form-control mb-2" placeholder="Tu nombre" required />
                <button type="submit" class="btn btn-success w-100">Guardar Récord</button>
            </form>
        </div>
    </div>

    <div class="mt-5">
        <h4>🏆 Tabla de Líderes</h4>
        <table class="table table-sm table-striped" style="max-width: 600px; margin: 0 auto;">
            <thead class="table-dark">
                <tr>
                    <th>Jugador</th>
                    <th>Puntaje</th>
                    <th>Movimientos</th>
                    <th>Tiempo</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var record in Model)
                {
                    <tr>
                        <td>@record.PlayerName</td>
                        <td class="fw-bold text-success">@record.Score</td>
                        <td>@record.Moves</td>
                        <td>@record.TimeSeconds s</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<script>
    const icons = ["🐶", "🐱", "🐭", "🐹", "🐰", "🦊", "🐻", "🐼"];
    let cards = []; // Aquí guardaremos los pares
    let firstCard = null;
    let secondCard = null;
    let lockBoard = false;
    let moves = 0;
    let matches = 0;
    let time = 0;
    let timerInterval = null;

    // Al cargar la página, iniciamos
    document.addEventListener("DOMContentLoaded", restartGame);

    function restartGame() {
        // Resetear variables
        const board = document.getElementById("board");
        board.innerHTML = "";
        document.getElementById("winForm").style.display = "none";
        moves = 0;
        matches = 0;
        time = 0;
        firstCard = null;
        secondCard = null;
        lockBoard = false;
        updateStats();

        // Reiniciar reloj
        clearInterval(timerInterval);
        timerInterval = setInterval(() => { time++; updateStats(); }, 1000);

        // Crear baraja (duplicar iconos y mezclar)
        let deck = [...icons, ...icons];
        deck.sort(() => 0.5 - Math.random());

        // Crear HTML de las cartas
        deck.forEach(icon => {
            const card = document.createElement("div");
            card.classList.add("card-game");
            card.dataset.value = icon;
            card.innerText = icon; // El emoji está ahí pero oculto por CSS
            card.addEventListener("click", flipCard);
            board.appendChild(card);
        });
    }

    function flipCard() {
        if (lockBoard) return;
        if (this === firstCard) return; // No puedes clicar la misma carta dos veces

        this.classList.add("flipped");

        if (!firstCard) {
            // Primer clic
            firstCard = this;
            return;
        }

        // Segundo clic
        secondCard = this;
        moves++;
        updateStats();
        checkForMatch();
    }

    function checkForMatch() {
        let isMatch = firstCard.dataset.value === secondCard.dataset.value;

        if (isMatch) {
            disableCards();
        } else {
            unflipCards();
        }
    }

    function disableCards() {
        firstCard.classList.add("matched");
        secondCard.classList.add("matched");
        matches++;
        resetBoard();

        // Verificar victoria (8 pares)
        if (matches === icons.length) {
            endGame();
        }
    }

    function unflipCards() {
        lockBoard = true;
        setTimeout(() => {
            firstCard.classList.remove("flipped");
            secondCard.classList.remove("flipped");
            resetBoard();
        }, 1000);
    }

    function resetBoard() {
        [firstCard, secondCard, lockBoard] = [null, null, false];
    }

    function updateStats() {
        document.getElementById("moveCount").innerText = moves;
        document.getElementById("timer").innerText = time;
    }

    function endGame() {
        clearInterval(timerInterval);

        // Calcular puntaje: (1000 base) - (tiempo * 2) - (movimientos * 5)
        let score = Math.max(0, 1000 - (time * 2) - (moves * 5));

        // Mostrar formulario
        document.getElementById("winForm").style.display = "block";
        document.getElementById("finalScoreDisplay").innerText = score;

        // Llenar inputs ocultos para enviar al servidor
        document.getElementById("inputMoves").value = moves;
        document.getElementById("inputTime").value = time;
        document.getElementById("inputScore").value = score;
    }
</script>