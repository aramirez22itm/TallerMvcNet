@model List<TallerMvcNet.Models.TimeRecord>

<div class="container mt-5 text-center">
    <h2>⏱️ Cronómetro Online</h2>

    <div class="card bg-dark text-white mb-4 mx-auto shadow" style="max-width: 400px;">
        <div class="card-body">
            <h1 id="display" style="font-size: 4rem; font-family: monospace;">00:00:00</h1>
        </div>
    </div>

    <div class="mb-4">
        <button id="btnStart" class="btn btn-success btn-lg mx-2" onclick="startTimer()">▶ Iniciar</button>
        <button id="btnPause" class="btn btn-warning btn-lg mx-2" onclick="pauseTimer()" disabled>⏸ Pausar</button>
        <button id="btnReset" class="btn btn-danger btn-lg mx-2" onclick="resetTimer()">⏹ Reiniciar</button>
    </div>

    <div class="card mb-4 mx-auto" style="max-width: 500px;">
        <div class="card-header bg-primary text-white">Guardar este tiempo</div>
        <div class="card-body">
            <form asp-action="SaveTime" method="post" class="d-flex gap-2">
                <input type="hidden" id="timeInput" name="timeRecorded" />

                <input type="text" name="comment" class="form-control" placeholder="Comentario (ej: Récord personal)" required />
                <button type="submit" class="btn btn-primary" onclick="prepareSave()">💾 Guardar</button>
            </form>
        </div>
    </div>

    <hr />

    <h3>📜 Historial Guardado</h3>
    @if (Model.Count > 0)
    {
        <div class="table-responsive" style="max-width: 600px; margin: 0 auto;">
            <table class="table table-striped text-start">
                <thead>
                    <tr>
                        <th>Tiempo</th>
                        <th>Fecha</th>
                        <th>Comentario</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td class="fw-bold text-primary">@item.Time</td>
                            <td>@item.Date.ToShortTimeString()</td>
                            <td>@item.Comment</td>
                        </tr>
                    }
                </tbody>
            </table>
            <a href="@Url.Action("ClearHistory")" class="btn btn-sm btn-outline-secondary">Borrar Historial</a>
        </div>
    }
    else
    {
        <p class="text-muted">No has guardado ningún tiempo aún.</p>
    }
</div>

<script>
    let timer;
    let seconds = 0;
    let isRunning = false;

    function startTimer() {
        if (!isRunning) {
            isRunning = true;
            document.getElementById("btnStart").disabled = true;
            document.getElementById("btnPause").disabled = false;

            timer = setInterval(() => {
                seconds++;
                updateDisplay();
            }, 1000); // Actualiza cada segundo (se puede bajar a 10 para centésimas)
        }
    }

    function pauseTimer() {
        if (isRunning) {
            isRunning = false;
            clearInterval(timer);
            document.getElementById("btnStart").disabled = false;
            document.getElementById("btnPause").disabled = true;
        }
    }

    function resetTimer() {
        pauseTimer();
        seconds = 0;
        updateDisplay();
    }

    function updateDisplay() {
        // Calculo para convertir segundos a HH:MM:SS
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;

        // Formato para que siempre tenga 2 dígitos (01, 02...)
        const formatted =
            (hrs < 10 ? "0" + hrs : hrs) + ":" +
            (mins < 10 ? "0" + mins : mins) + ":" +
            (secs < 10 ? "0" + secs : secs);

        document.getElementById("display").innerText = formatted;
    }

    function prepareSave() {
        // Antes de enviar el formulario, copia el tiempo actual al input oculto
        const currentTime = document.getElementById("display").innerText;
        document.getElementById("timeInput").value = currentTime;
    }
</script>